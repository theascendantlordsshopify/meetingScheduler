<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MeetXccelerate - All Integrations</title>

    <!-- CSS File -->
    <link rel="stylesheet" href="Style.css" />
    <link rel="shortcut icon" href="./images/favicon.png" type="image/x-icon">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body>
    <!-- Header -->
    <header class="main-header">
        <div class="header-right">
            <button class="icon-btn">
                <i class="fa-regular fa-circle-question" id="help"></i>
            </button>
            <img src="./images/profile.jpg" alt="User" class="profile-pic">
        </div>
    </header>

    <main class="container">
        <h1>All Integrations</h1>
        <p>Connect your favorite tools to streamline scheduling and workflows.</p>

        <!-- Search Bar -->
        <div class="search-container">
            <input type="text" placeholder="Search integrations..." id="searchInput">
            <span class="close-btn" onclick="clearSearch()">âœ•</span>
        </div>

        <!-- Integration Cards Container -->
        <div id="integrations-container">
            <!-- Dynamic content will be loaded here -->
        </div>
    </main>

    <!-- JavaScript -->
    <script src="../project/js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            await loadAllIntegrations();
            setupSearch();
        });
        
        async function loadAllIntegrations() {
            try {
                const providers = await window.api.getIntegrationProviders();
                const userIntegrations = await window.api.getUserIntegrations();
                
                renderAllIntegrations(providers, userIntegrations);
            } catch (error) {
                console.error('Failed to load integrations:', error);
                showError('Failed to load integrations');
            }
        }
        
        function renderAllIntegrations(providers, userIntegrations) {
            const container = document.getElementById('integrations-container');
            container.innerHTML = '';
            
            providers.forEach(provider => {
                const isConnected = userIntegrations.some(ui => ui.provider === provider.id);
                
                const card = document.createElement('div');
                card.className = 'integration-card';
                
                card.innerHTML = `
                    <div class="integration-info">
                        <img src="${provider.logo_url || './logos/default.png'}" alt="${provider.name}">
                        <div class="integration-text">
                            <h4>${provider.name}</h4>
                            <p>${provider.description}</p>
                        </div>
                    </div>
                    <button class="connect-btn" onclick="handleIntegration(${provider.id}, '${provider.name}', ${isConnected})">
                        ${isConnected ? 'Connected' : 'Connect'}
                    </button>
                `;
                
                container.appendChild(card);
            });
        }
        
        async function handleIntegration(providerId, providerName, isConnected) {
            if (isConnected) {
                // Handle disconnect or manage settings
                console.log(`Manage ${providerName} integration`);
                return;
            }
            
            try {
                await window.api.connectIntegration({
                    provider_id: providerId,
                    settings: {}
                });
                
                alert(`${providerName} connected successfully!`);
                await loadAllIntegrations();
            } catch (error) {
                console.error('Failed to connect integration:', error);
                alert('Failed to connect integration: ' + error.message);
            }
        }
        
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    filterIntegrations(query);
                });
            }
        }
        
        function filterIntegrations(query) {
            const cards = document.querySelectorAll('.integration-card');
            
            cards.forEach(card => {
                const title = card.querySelector('h4').textContent.toLowerCase();
                const description = card.querySelector('p').textContent.toLowerCase();
                
                if (title.includes(query) || description.includes(query) || query === '') {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filterIntegrations('');
        }
        
        function showError(message) {
            console.error(message);
            alert('Error: ' + message);
        }
    </script>
</body>

</html>