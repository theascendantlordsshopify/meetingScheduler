/* ========================= PROFILE DROPDOWN ============================ */
const profileBtn = document.getElementById("profileBtn");
const dropdownMenu = document.getElementById("dropdownMenu");

if (profileBtn && dropdownMenu) {
    profileBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdownMenu.style.display =
            dropdownMenu.style.display === "flex" ? "none" : "flex";
    });

    document.addEventListener("click", () => {
        dropdownMenu.style.display = "none";
    });
}

/* ====================== DASHBOARD INITIALIZATION ===================== */
document.addEventListener("DOMContentLoaded", function () {
    // Load dashboard data
    loadDashboardData();
    loadUpcomingMeetings();
    loadRecentActivity();
    loadUserGreeting();
    
    // Set up event listeners
    const addMeetingBtn = document.getElementById("addMeetingBtn");
    if (addMeetingBtn) {
        addMeetingBtn.addEventListener("click", createDummyMeeting);
    }
});

async function loadDashboardData() {
    try {
        const stats = await window.api.getDashboardStats();
        updateStatsCards(stats);
    } catch (error) {
        console.error('Failed to load dashboard stats:', error);
    }
}

async function loadUpcomingMeetings() {
    try {
        const meetings = await window.api.getUpcomingMeetings();
        renderMeetings(meetings);
    } catch (error) {
        console.error('Failed to load meetings:', error);
    }
}

async function loadRecentActivity() {
    try {
        const meetings = await window.api.getMeetings();
        renderRecentActivity(meetings);
    } catch (error) {
        console.error('Failed to load recent activity:', error);
    }
}

async function loadUserGreeting() {
    try {
        const profile = await window.api.getProfile();
        const greeting = document.getElementById('greeting');
        if (greeting && profile.first_name) {
            const hour = new Date().getHours();
            let timeGreeting = 'Good Morning';
            if (hour >= 12 && hour < 17) timeGreeting = 'Good Afternoon';
            else if (hour >= 17) timeGreeting = 'Good Evening';
            
            greeting.textContent = `${timeGreeting}, ${profile.first_name}`;
        }
    } catch (error) {
        console.error('Failed to load user profile:', error);
    }
}

async function createDummyMeeting() {
    try {
        const eventTypesResponse = await window.api.getEventTypes();
        const eventTypes = eventTypesResponse.results || eventTypesResponse;
        
        if (eventTypes.length === 0) {
            alert('Please create an event type first');
            return;
        }

        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(10, 0, 0, 0);

        const dummyMeetingData = {
            event_type: eventTypes[0].id,
            title: "Team Huddle",
            start_time: tomorrow.toISOString(),
            timezone: "UTC",
            invitee_name: "John Doe",
            invitee_email: "john.doe@example.com"
        };

        await window.api.createMeeting(dummyMeetingData);
        loadUpcomingMeetings(); // Refresh the list
    } catch (error) {
        console.error('Failed to create dummy meeting:', error);
        alert('Failed to create meeting: ' + error.message);
    }
}

function renderMeetings(meetings) {
    const meetingList = document.querySelector(".meeting-list");
    if (!meetingList) return;

    // Clear existing dynamic meetings
    const existingMeetings = meetingList.querySelectorAll("li.dynamic-meeting");
    existingMeetings.forEach(li => li.remove());

    meetings.forEach((meeting) => {
        const li = document.createElement("li");
        li.className = "dynamic-meeting";
        const meetingTime = formatDateTime(meeting.start_time);
        li.innerHTML = `
            <div class="icon"><i class="fas fa-clock"></i></div>
            <div class="info"><strong>${meeting.title}</strong><br /><span>${meetingTime}</span></div>
            <div class="arrow"><i class="fas fa-chevron-right"></i></div>
        `;
        meetingList.appendChild(li);
    });
}

function renderRecentActivity(meetings) {
    const tbody = document.getElementById('recent-activity-tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    meetings.slice(0, 5).forEach(meeting => {
        const row = document.createElement('tr');
        const meetingTime = formatDateTime(meeting.start_time);
        
        row.innerHTML = `
            <td>${meeting.title}</td>
            <td>${meeting.invitee_name}</td>
            <td>${meetingTime}</td>
            <td>${meeting.location_type === 'zoom' ? 'Virtual' : meeting.location_type}</td>
            <td>${meeting.description || 'No notes'}</td>
        `;
        
        tbody.appendChild(row);
    });
}

function updateStatsCards(stats) {
    const cards = document.querySelectorAll('.stats .card');
    if (cards.length >= 4) {
        cards[0].textContent = stats.confirmed_meetings || 0;
        cards[1].textContent = stats.pending_meetings || 0;
        cards[2].textContent = stats.cancelled_meetings || 0;
        cards[3].textContent = stats.todays_meetings || 0;
    }
}

function updateDurationValue() {
    const duration = document.getElementById("duration").value;
    document.getElementById("duration-value").textContent = duration + " min";
}

function proceedToNextStep() {
    const eventName = document.getElementById("event-name").value.trim();
    const category = document.getElementById("event-category").value;
    const duration = document.getElementById("duration").value;
    const description = document.getElementById("feedback").value.trim();
    
    if (!eventName) {
        alert('Please enter an event name');
        return;
    }
    
    // Store in session for next steps
    const eventData = {
        name: eventName,
        category: category,
        duration: duration,
        description: description
    };
    
    sessionStorage.setItem('newEventData', JSON.stringify(eventData));
    window.location.href = 'selectDate.html';
}